name: Build NixOS ISO

on:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # Required for creating releases and uploading artifacts
      actions: read    # Required for reading workflow information
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - uses: wimpysworld/nothing-but-nix@main
      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixos-25.11
          extra_nix_config: |
            experimental-features = nix-command flakes
            substituters = https://cache.nixos.org
            trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY=
      - name: Build ISO
        run: |
          mkdir -p ~/.config/nixpkgs
          echo "{ allowUnfree = true; }" >> ~/.config/nixpkgs/config.nix
          nix build .#iso -L --show-trace

      - name: Get ISO info
        id: iso_info
        run: |
          ISO_PATH=$(readlink -f result/iso/*.iso)
          ISO_NAME=$(basename "$ISO_PATH")
          ISO_SIZE=$(du -h "$ISO_PATH" | cut -f1)
          echo "iso_path=$ISO_PATH" >> $GITHUB_OUTPUT
          echo "iso_name=$ISO_NAME" >> $GITHUB_OUTPUT
          echo "iso_size=$ISO_SIZE" >> $GITHUB_OUTPUT
          
          # Calculate SHA256 checksum
          SHA256=$(sha256sum "$ISO_PATH" | cut -d' ' -f1)
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          
          echo "ISO Name: $ISO_NAME"
          echo "ISO Size: $ISO_SIZE"
          echo "SHA256: $SHA256"

      - name: Install SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          echo "${{ secrets.SSH_KNOWN_HOSTS }}" >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: Upload ISO as artifact
        uses: actions/upload-artifact@v4
        with:
          name: nixos-iso
          path: ${{ steps.iso_info.outputs.iso_path }}
          retention-days: 30

      - name: Upload to sourceforge
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          sha256sum ${{ steps.iso_info.outputs.iso_path }} > "${{ steps.iso_info.outputs.iso_name }}.sha256"
          rsync -e ssh ${{ steps.iso_info.outputs.iso_path }} grassblock@frs.sourceforge.net:/home/frs/project/dumb-live-iso/releases/nix
          rsync -e ssh "${{ steps.iso_info.outputs.iso_name }}.sha256" grassblock@frs.sourceforge.net:/home/frs/project/dumb-live-iso/releases/nix

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          body: |
            因为 NixOS 的 ISO 文件通常较大，GitHub Releases 对于单个文件的大小有限制（通常为 2GB）。因此，我们将 ISO 文件上传到 SourceForge，并在 GitHub Release 中提供下载链接和校验和信息。
            
            ## 下载链接
            - [SourceForge 下载链接](https://sourceforge.net/projects/dumb-live-iso/files/releases/nix/${{ steps.iso_info.outputs.iso_name }}/download)

        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

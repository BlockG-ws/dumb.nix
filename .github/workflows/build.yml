name: Build NixOS ISO

on:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # Required for creating releases and uploading artifacts
      actions: read    # Required for reading workflow information
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - uses: wimpysworld/nothing-but-nix@main
      - name: Install Nix
        uses: cachix/install-nix-action@v25
        with:
          nix_path: nixpkgs=channel:nixos-25.11
          extra_nix_config: |
            experimental-features = nix-command flakes
            substituters = https://cache.nixos.org
            trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY=
      - name: Build ISO
        run: |
          mkdir -p ~/.config/nixpkgs
          echo "{ allowUnfree = true; }" >> ~/.config/nixpkgs/config.nix
          nix build .#iso -L --show-trace

      - name: Get ISO info
        id: iso_info
        run: |
          ISO_PATH=$(readlink -f result/iso/*.iso)
          ISO_NAME=$(basename "$ISO_PATH")
          ISO_SIZE=$(du -h "$ISO_PATH" | cut -f1)
          echo "iso_path=$ISO_PATH" >> $GITHUB_OUTPUT
          echo "iso_name=$ISO_NAME" >> $GITHUB_OUTPUT
          echo "iso_size=$ISO_SIZE" >> $GITHUB_OUTPUT
          
          # Calculate SHA256 checksum
          SHA256=$(sha256sum "$ISO_PATH" | cut -d' ' -f1)
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          
          echo "ISO Name: $ISO_NAME"
          echo "ISO Size: $ISO_SIZE"
          echo "SHA256: $SHA256"

      - name: Upload ISO as artifact
        uses: actions/upload-artifact@v4
        with:
          name: nixos-iso
          path: ${{ steps.iso_info.outputs.iso_path }}
          retention-days: 30

      - name: Create checksums file
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          cd result/iso
          sha256sum *.iso > SHA256SUMS
          cat SHA256SUMS

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            result/iso/*.iso
            result/iso/SHA256SUMS
          body: |
            ## Dumb NixOS Live ISO
            
            ### 特性
            - ✅ 通过 shim 支持安全启动
            - ✅ 预装常用的硬件测试工具和维护工具
            - ✅ 包含官方仓库内几乎所有驱动
            - ✅ 预置 Windows 系统维护工具（修改密码、注册表、WIM/ESD 处理）
            - ✅ 预置 Clonezilla 和其服务端
            - ✅ 预置 fcitx5 输入法和中文输入支持
            - ✅ 使用 XFCE4 桌面环境
            - ✅ 开箱即用的配置文件
            - ✅ 支持 ZFS、SSH 连接、chroot 到其它发行版
            
            ### 系统信息
            - ISO 大小: ${{ steps.iso_info.outputs.iso_size }}
            - SHA256: `${{ steps.iso_info.outputs.sha256 }}`
            
            ### 默认登录信息
            - 用户名: `nixos` / `root`
            - 密码: `nixos`
            
            ### 使用说明
            1. 下载 ISO 文件
            2. 使用 Rufus (Windows) 或 dd (Linux) 写入 USB
            3. 从 USB 启动系统
            4. 系统会自动登录到 XFCE4 桌面
            
            详细使用说明请参考仓库中的 README_CN.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
